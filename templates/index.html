<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Finance AI</title>

<link rel="manifest" href="/static/manifest.json">
<meta name="theme-color" content="#820AD1">

<style>
:root{
  --primary:#820AD1;
  --bg:#0f0f14;
  --card:#1a1a22;
  --text:#ffffff;
  --muted:#9a9aa3;
  --danger:#ff4d4f;
  --success:#00c853;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto;
  background:var(--bg);
  color:var(--text);
}

header{
  background:var(--primary);
  padding:20px;
  font-weight:600;
  font-size:20px;
}

.container{
  padding:16px;
  padding-bottom:80px;
}

.card{
  background:var(--card);
  border-radius:16px;
  padding:16px;
  margin-bottom:16px;
}

h2{
  margin:0 0 12px 0;
  font-size:18px;
}

input,select,button{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:none;
  margin-bottom:10px;
  font-size:14px;
}

input,select{
  background:#2a2a35;
  color:#fff;
}

button{
  background:var(--primary);
  color:#fff;
  font-weight:600;
  cursor:pointer;
}

.bottom-nav{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  background:#14141c;
  display:flex;
  justify-content:space-around;
  padding:12px 0;
  border-top:1px solid #222;
}

.bottom-nav button{
  background:none;
  color:#bbb;
  font-size:12px;
  border:none;
}

.bottom-nav button.active{
  color:var(--primary);
  font-weight:600;
}

.hidden{display:none}
.alert{
  padding:12px;
  border-radius:12px;
  margin-bottom:10px;
}
.alert.warn{background:#332200;color:#ffc107}
.alert.danger{background:#330000;color:#ff4d4f}
.alert.ok{background:#002e1c;color:#00e676}
</style>
</head>

<body>

<header>Finance AI</header>

<div class="container">

<!-- DASHBOARD -->
<div id="tab-dashboard" class="tab hidden">
  <div class="card">
    <h2>Resumo do Mês</h2>
    <div id="dash-resumo"></div>
  </div>

  <div class="card">
    <h2>Insights</h2>
    <div id="dash-insights"></div>
  </div>

  <div class="card">
    <h2>Alertas</h2>
    <div id="dash-alerts"></div>
  </div>
</div>

<!-- LANÇAR -->
<div id="tab-lancar" class="tab hidden">
  <div class="card">
    <h2>Novo Lançamento</h2>
    <select id="tipo">
      <option>Receita</option>
      <option>Gasto</option>
    </select>
    <input id="categoria" placeholder="Categoria">
    <input id="descricao" placeholder="Descrição">
    <input id="valor" type="number" step="0.01" placeholder="Valor">
    <button onclick="lancar()">Salvar</button>
  </div>
</div>

<!-- INVESTIR -->
<div id="tab-investir" class="tab hidden">
  <div class="card">
    <h2>Novo Investimento</h2>
    <input id="ativo" placeholder="Ativo (ex: CDB, Ação)">
    <select id="operacao">
      <option>Aporte</option>
      <option>Resgate</option>
      <option>Rendimento</option>
    </select>
    <input id="inv_categoria" placeholder="Categoria">
    <input id="inv_descricao" placeholder="Descrição">
    <input id="inv_valor" type="number" step="0.01" placeholder="Valor">
    <button onclick="investir()">Registrar</button>
  </div>
</div>

<!-- LISTA -->
<div id="tab-ultimos" class="tab hidden">
  <div class="card">
    <h2>Lançamentos</h2>
    <div id="lista"></div>
  </div>
</div>

</div>

<!-- NAV -->
<div class="bottom-nav">
  <button onclick="showTab('dashboard')" id="btn-dashboard">Dashboard</button>
  <button onclick="showTab('lancar')" id="btn-lancar">Lançar</button>
  <button onclick="showTab('investir')" id="btn-investir">Investir</button>
  <button onclick="showTab('ultimos')" id="btn-ultimos">Lista</button>
</div>

<script src="/static/vendor/chart.umd.min.js"></script>

<script>
function showTab(tab){
  document.querySelectorAll('.tab').forEach(t=>t.classList.add('hidden'));
  document.querySelectorAll('.bottom-nav button').forEach(b=>b.classList.remove('active'));

  document.getElementById('tab-'+tab).classList.remove('hidden');
  document.getElementById('btn-'+tab).classList.add('active');

  history.replaceState(null,null,'/?tab='+tab);

  if(tab==='dashboard') loadDashboard();
  if(tab==='ultimos') loadLista();
}

async function loadDashboard(){
  const res=await fetch('/dashboard');
  const data=await res.json();

  document.getElementById('dash-resumo').innerHTML=
    `Entradas: R$ ${data.entradas.toFixed(2)}<br>
     Saídas: R$ ${data.saidas.toFixed(2)}<br>
     Saldo: R$ ${data.saldo.toFixed(2)}`;

  document.getElementById('dash-insights').innerHTML=
    data.insights.map(i=>`<div class="alert ok"><b>${i.title}</b><br>${i.desc}</div>`).join('');

  document.getElementById('dash-alerts').innerHTML=
    data.alerts.map(a=>`<div class="alert ${a.level}"><b>${a.title}</b><br>${a.desc}</div>`).join('');
}

async function lancar(){
  await fetch('/lancar',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      tipo:tipo.value,
      categoria:categoria.value,
      descricao:descricao.value,
      valor:valor.value
    })
  });
  alert("Salvo");
}

async function investir(){
  await fetch('/investir',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      ativo:ativo.value,
      operacao:operacao.value,
      categoria:inv_categoria.value,
      descricao:inv_descricao.value,
      valor:inv_valor.value
    })
  });
  alert("Investimento registrado");
}

async function loadLista(){
  const res=await fetch('/ultimos');
  const data=await res.json();
  document.getElementById('lista').innerHTML=
    data.items.map(i=>`
      <div class="card">
        <b>${i.Tipo}</b> - ${i.Categoria}<br>
        ${i.Descrição}<br>
        R$ ${i.Valor}
      </div>`).join('');
}

/* ======================
   Abrir aba via URL
====================== */
(function init(){
  const tab=new URLSearchParams(location.search).get('tab');
  const allowed=['dashboard','lancar','ultimos','investir'];
  if(tab && allowed.includes(tab)){
    showTab(tab);
  }else{
    showTab('dashboard');
  }
})();

/* ======================
   Service Worker (1 único registro)
====================== */
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{
    navigator.serviceWorker.register('/sw.js');
  });
}
</script>

</body>
</html>
