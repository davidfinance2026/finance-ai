<!doctype html>
<html lang="pt-BR">
<head>
  <meta name="theme-color" content="#0b1020">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Finance AI</title>
  <link rel="manifest" href="/static/manifest.json">

  <!-- Chart.js (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#070B18; --panel:#0B1024; --text:#EAF0FF; --muted:#93A4C7;
      --brand:#4B8CFF; --danger:#FF4B6E; --ok:#2EE59D;
      --border:rgba(255,255,255,.10); --shadow:0 14px 50px rgba(0,0,0,.55);
      --radius:18px; --radius2:26px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 700px at 10% 0%, rgba(75,140,255,.20), transparent 55%),
                  radial-gradient(900px 600px at 90% 25%, rgba(46,229,157,.10), transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    code{opacity:.9}
    .wrap{max-width:980px;margin:0 auto;padding:22px 16px 70px}
    .topbar{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:16px}
    .brand h1{margin:0;font-size:28px}
    .brand p{margin:6px 0 0;color:var(--muted);font-size:14px}

    .btn{
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      color:var(--text);
      padding:10px 14px;border-radius:999px;cursor:pointer;
      transition:.15s transform,.2s background;
      display:inline-flex;align-items:center;gap:8px;user-select:none;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn.primary{
      border-color:rgba(75,140,255,.45);
      background: linear-gradient(180deg, rgba(75,140,255,.35), rgba(45,107,255,.18));
    }
    .btn.danger{
      border-color:rgba(255,75,110,.45);
      background: linear-gradient(180deg, rgba(255,75,110,.28), rgba(255,75,110,.10));
    }
    .btn.small{padding:8px 12px;font-size:13px}

    .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--border);color:var(--muted);font-size:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .spacer{flex:1}
    .muted{color:var(--muted)}
    .grid{display:grid;gap:14px}
    @media(min-width:840px){.grid.cols2{grid-template-columns:1fr 1fr}}

    .tabs{
      display:flex;gap:10px;flex-wrap:wrap;
      padding:8px;border-radius:999px;border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      margin:14px 0 16px;width:fit-content;
    }
    .tab{
      padding:10px 14px;border-radius:999px;cursor:pointer;
      color:var(--muted);border:1px solid transparent;user-select:none;font-weight:700;font-size:14px;
    }
    .tab.active{
      color:var(--text);
      border-color:rgba(75,140,255,.35);
      background: linear-gradient(180deg, rgba(75,140,255,.26), rgba(75,140,255,.10));
    }

    .card{
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      padding:16px;
      overflow:hidden;
    }
    .card h2{margin:0 0 8px;font-size:14px;letter-spacing:.4px;color:var(--muted);text-transform:uppercase}

    .field{display:flex;flex-direction:column;gap:8px;margin-top:10px}
    label{font-size:12px;color:var(--muted);letter-spacing:.2px}
    input,select,textarea{
      width:100%;border-radius:14px;padding:12px 12px;border:1px solid var(--border);
      background: rgba(0,0,0,.20);color:var(--text);outline:none;
    }
    textarea{min-height:92px;resize:vertical}
    .split{display:grid;gap:10px}
    @media(min-width:640px){.split{grid-template-columns:1fr 1fr}}

    .toast{margin-top:12px;padding:12px 12px;border-radius:16px;border:1px solid var(--border);
      background: rgba(0,0,0,.25);display:none}
    .toast.show{display:block}
    .toast.ok{border-color:rgba(46,229,157,.35)}
    .toast.err{border-color:rgba(255,75,110,.35)}
    .toast .t{font-weight:800}
    .toast .d{color:var(--muted);font-size:13px;margin-top:4px}

    .hidden{display:none !important}
    .divider{height:1px;background:var(--border);margin:14px 0}

    /* modal */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:flex-end;justify-content:center;padding:16px;z-index:50}
    .overlay.show{display:flex}
    .modal{
      width:min(560px, 100%);
      border-radius:26px;border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(11,16,36,.98), rgba(7,11,24,.98));
      box-shadow: var(--shadow);padding:16px;
    }
    .modalHead{display:flex;align-items:center;gap:12px}
    .modalHead h3{margin:0;font-size:20px}
    .x{margin-left:auto;width:42px;height:42px;border-radius:999px;border:1px solid var(--border);
      background: rgba(255,255,255,.05);cursor:pointer;color:var(--text);font-size:18px}
    .segTabs{margin-top:12px;display:flex;gap:8px;padding:6px;border-radius:999px;border:1px solid var(--border);background: rgba(255,255,255,.04)}
    .seg{flex:1;text-align:center;padding:10px 12px;border-radius:999px;cursor:pointer;color:var(--muted);font-weight:800;user-select:none}
    .seg.active{color:var(--text);background: linear-gradient(180deg, rgba(75,140,255,.26), rgba(75,140,255,.10));border:1px solid rgba(75,140,255,.35)}
    .hint{font-size:12px;color:var(--muted);margin-top:8px}

    /* list cards */
    .miniCard{
      box-shadow:none;border-radius:18px;background:rgba(255,255,255,.03);
      border:1px solid var(--border);padding:12px;
    }
    .kpi{font-weight:900}

    /* chart */
    .chartBox{
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      border-radius: 18px;
      padding: 12px;
      margin-top: 12px;
    }
    .chartTitle{
      display:flex;align-items:center;gap:10px;
      font-weight:900;
      margin:0 0 8px;
    }
    .chartHint{color:var(--muted);font-size:12px;margin:0 0 10px}
    canvas{width:100% !important; height:260px !important;}
    @media(min-width:840px){
      canvas{height:280px !important;}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <h1>Finance AI</h1>
        <p>Controle financeiro â€¢ simples e rÃ¡pido</p>
      </div>
      <div class="row">
        <span id="userPill" class="pill hidden"></span>
        <button id="btnLogin" class="btn primary">ðŸ”’ Login</button>
        <button id="btnLogout" class="btn danger hidden">Sair</button>
      </div>
    </div>

    <div class="tabs" role="tablist" aria-label="NavegaÃ§Ã£o">
      <div class="tab" data-tab="lancar">LanÃ§ar</div>
      <div class="tab" data-tab="ultimos">Ãšltimos</div>
      <div class="tab active" data-tab="dashboard">Dashboard</div>
      <div class="tab" data-tab="investimentos">Investimentos</div>
    </div>

    <!-- DASHBOARD -->
    <section id="tab-dashboard" class="grid cols2">
      <div class="card">
        <h2>Dashboard do mÃªs</h2>

        <div class="split">
          <div class="field">
            <label>MÃªs</label>
            <select id="dashMes"></select>
          </div>
          <div class="field">
            <label>Ano</label>
            <input id="dashAno" inputmode="numeric" placeholder="2026" />
          </div>
        </div>

        <div class="divider"></div>

        <div class="grid" style="gap:10px">
          <div class="miniCard">
            <div class="row">
              <div class="muted" style="font-weight:900">RECEITAS</div>
              <div class="spacer"></div>
              <div id="valReceitas" class="kpi">R$ 0,00</div>
            </div>
          </div>
          <div class="miniCard">
            <div class="row">
              <div class="muted" style="font-weight:900">GASTOS</div>
              <div class="spacer"></div>
              <div id="valGastos" class="kpi">R$ 0,00</div>
            </div>
          </div>
          <div class="miniCard">
            <div class="row">
              <div class="muted" style="font-weight:900">SALDO</div>
              <div class="spacer"></div>
              <div id="valSaldo" class="kpi">R$ 0,00</div>
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:14px">
          <button id="btnAtualizarDash" class="btn primary">Atualizar Dashboard</button>
          <div class="spacer"></div>
          <span class="hint">FaÃ§a login para ver seus dados.</span>
        </div>

        <div id="toastDash" class="toast"></div>
      </div>

      <!-- GrÃ¡ficos -->
      <div class="card">
        <h2>Visual</h2>

        <div class="chartBox">
          <div class="chartTitle">ðŸ“Š Receitas x Gastos</div>
          <p class="chartHint">Atualiza automaticamente com o mÃªs/ano selecionados.</p>
          <canvas id="chartRG"></canvas>
        </div>

        <div class="chartBox">
          <div class="chartTitle">ðŸ“ˆ Saldo do mÃªs</div>
          <p class="chartHint">Verde (positivo) ou vermelho (negativo).</p>
          <canvas id="chartSaldo"></canvas>
        </div>

        <div class="chartBox">
          <div class="chartTitle">ðŸ—“ï¸ EvoluÃ§Ã£o diÃ¡ria</div>
          <p class="chartHint">Receitas e Gastos por dia + <b>Saldo acumulado</b>.</p>
          <canvas id="chartDaily"></canvas>
        </div>

        <div class="divider"></div>

        <div class="row">
          <button class="btn" id="goLancar">âž• LanÃ§ar agora</button>
          <button class="btn" id="openLogin2">ðŸ”’ Abrir login</button>
          <button class="btn" id="goUltimos">ðŸ§¾ Ver Ãºltimos</button>
        </div>
      </div>
    </section>

    <!-- LANÃ‡AR -->
    <section id="tab-lancar" class="hidden">
      <div class="card">
        <h2>Novo lanÃ§amento</h2>

        <div class="split">
          <div class="field">
            <label>Tipo</label>
            <select id="lanTipo">
              <option value="RECEITA">RECEITA</option>
              <option value="GASTO">GASTO</option>
            </select>
          </div>

          <div class="field">
            <label>Data</label>
            <input id="lanData" type="date" />
          </div>
        </div>

        <div class="split">
          <div class="field">
            <label>Categoria</label>
            <input id="lanCategoria" placeholder="Ex: SalÃ¡rio, Mercado, Transporte..." />
          </div>

          <div class="field">
            <label>Valor (R$)</label>
            <input id="lanValor" inputmode="decimal" placeholder="Ex: 100,00" />
          </div>
        </div>

        <div class="field">
          <label>DescriÃ§Ã£o</label>
          <textarea id="lanDescricao" placeholder="Opcional..."></textarea>
        </div>

        <div class="row" style="margin-top:12px">
          <button id="btnSalvarLanc" class="btn primary">Salvar</button>
          <button id="btnLimparLanc" class="btn">Limpar</button>
          <div class="spacer"></div>
          <span class="hint">VocÃª precisa estar logado.</span>
        </div>

        <div id="toastLanc" class="toast"></div>
      </div>
    </section>

    <!-- ÃšLTIMOS -->
    <section id="tab-ultimos" class="hidden">
      <div class="card">
        <div class="row" style="align-items:center">
          <h2 style="margin:0">Ãšltimos lanÃ§amentos</h2>
          <div class="spacer"></div>
          <button class="btn primary" id="btnRecarregarUltimos">Recarregar</button>
        </div>

        <div class="hint" style="margin-top:8px">
          Mostra os Ãºltimos lanÃ§amentos do seu usuÃ¡rio. VocÃª pode <b>editar</b> ou <b>apagar</b>.
        </div>

        <div id="toastUltimos" class="toast"></div>
        <div id="listaUltimos" style="margin-top:12px;display:grid;gap:10px"></div>
      </div>
    </section>

    <!-- INVESTIMENTOS -->
    <section id="tab-investimentos" class="hidden">
      <div class="card">
        <h2>Investimentos</h2>
        <p class="muted" style="margin:0;line-height:1.6">
          Tela pronta para evoluir. Se vocÃª quiser registrar investimentos no Sheets, eu adiciono:
          <b>POST /api/investimentos</b> e <b>GET /api/investimentos</b>.
        </p>
      </div>
    </section>
  </div>

  <!-- MODAL AUTH + EDIT -->
  <div id="overlay" class="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHead">
        <div style="font-size:22px" id="modalIcon">ðŸ”’</div>
        <div>
          <h3 id="modalTitle">Login</h3>
          <div class="hint" id="modalSub">Entre com seu e-mail e senha.</div>
        </div>
        <button class="x" id="closeModal">âœ•</button>
      </div>

      <!-- AUTH MODE -->
      <div id="authBlock">
        <div class="segTabs">
          <div class="seg active" data-seg="entrar">Entrar</div>
          <div class="seg" data-seg="criar">Criar conta</div>
          <div class="seg" data-seg="reset">Resetar senha</div>
        </div>

        <div id="seg-entrar" style="margin-top:12px">
          <div class="field">
            <label>E-mail</label>
            <input id="loginEmail" type="email" placeholder="seuemail@dominio.com" />
          </div>
          <div class="field">
            <label>Senha</label>
            <input id="loginSenha" type="password" placeholder="Sua senha" />
          </div>

          <div class="row" style="margin-top:12px">
            <button id="btnEntrar" class="btn primary" style="flex:1">Entrar</button>
            <button class="btn" id="btnFechar1">Sair</button>
          </div>

          <div id="toastAuth1" class="toast"></div>
        </div>

        <div id="seg-criar" class="hidden" style="margin-top:12px">
          <div class="split">
            <div class="field">
              <label>Nome / Apelido</label>
              <input id="regApelido" placeholder="Ex: David" />
            </div>
            <div class="field">
              <label>Telefone</label>
              <input id="regTelefone" inputmode="tel" placeholder="(37) 99999-9999" />
            </div>
          </div>

          <div class="field">
            <label>Nome completo</label>
            <input id="regNomeCompleto" placeholder="Seu nome completo" />
          </div>

          <div class="field">
            <label>E-mail</label>
            <input id="regEmail" type="email" placeholder="seuemail@dominio.com" />
          </div>

          <div class="split">
            <div class="field">
              <label>Senha</label>
              <input id="regSenha" type="password" placeholder="MÃ­nimo 6 caracteres" />
            </div>
            <div class="field">
              <label>Confirmar senha</label>
              <input id="regConf" type="password" placeholder="Repita a senha" />
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <button id="btnCriarConta" class="btn primary" style="flex:1">Criar conta</button>
            <button class="btn" id="btnFechar2">Sair</button>
          </div>

          <div id="toastAuth2" class="toast"></div>
        </div>

        <div id="seg-reset" class="hidden" style="margin-top:12px">
          <div class="field">
            <label>E-mail</label>
            <input id="rstEmail" type="email" placeholder="seuemail@dominio.com" />
          </div>
          <div class="split">
            <div class="field">
              <label>Nova senha</label>
              <input id="rstSenha" type="password" placeholder="MÃ­nimo 6 caracteres" />
            </div>
            <div class="field">
              <label>Confirmar</label>
              <input id="rstConf" type="password" placeholder="Repita a senha" />
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <button id="btnResetar" class="btn primary" style="flex:1">Resetar senha</button>
            <button class="btn" id="btnFechar3">Sair</button>
          </div>

          <div id="toastAuth3" class="toast"></div>
        </div>
      </div>

      <!-- EDIT MODE -->
      <div id="editBlock" class="hidden" style="margin-top:12px">
        <div class="split">
          <div class="field">
            <label>Tipo</label>
            <select id="edtTipo">
              <option value="RECEITA">RECEITA</option>
              <option value="GASTO">GASTO</option>
            </select>
          </div>
          <div class="field">
            <label>Data</label>
            <input id="edtData" type="date" />
          </div>
        </div>

        <div class="split">
          <div class="field">
            <label>Categoria</label>
            <input id="edtCategoria" placeholder="Ex: Mercado" />
          </div>
          <div class="field">
            <label>Valor (R$)</label>
            <input id="edtValor" inputmode="decimal" placeholder="Ex: 50,00" />
          </div>
        </div>

        <div class="field">
          <label>DescriÃ§Ã£o</label>
          <textarea id="edtDescricao" placeholder="Opcional..."></textarea>
        </div>

        <div class="row" style="margin-top:12px">
          <button id="btnSalvarEdicao" class="btn primary" style="flex:1">Salvar ediÃ§Ã£o</button>
          <button class="btn" id="btnCancelarEdicao">Cancelar</button>
        </div>

        <div id="toastEdit" class="toast"></div>
      </div>

    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    const moneyBR = (n) => {
      const v = Number(n || 0);
      return v.toLocaleString("pt-BR", { style:"currency", currency:"BRL" });
    };

    async function api(path, method="GET", body=null) {
      const opt = { method, headers: { "Content-Type":"application/json" }, credentials:"include" };
      if (body) opt.body = JSON.stringify(body);
      const res = await fetch(path, opt);
      let data = null;
      try { data = await res.json(); } catch(e) {}
      if (!res.ok) {
        const msg = (data && (data.error || data.message)) ? (data.error || data.message) : `Erro ${res.status}`;
        throw new Error(msg);
      }
      return data;
    }

    function showToast(el, type, title, desc="") {
      el.className = "toast show " + (type === "ok" ? "ok" : "err");
      el.innerHTML = `<div class="t">${title}</div>` + (desc ? `<div class="d">${desc}</div>` : "");
    }
    function hideToast(el) { el.className = "toast"; el.innerHTML = ""; }

    // -----------------------
    // Tabs
    // -----------------------
    const tabEls = Array.from(document.querySelectorAll(".tab"));

    function _setTabBase(name) {
      tabEls.forEach(t => t.classList.toggle("active", t.dataset.tab === name));
      ["dashboard","lancar","ultimos","investimentos"].forEach(n => {
        $("tab-" + n).classList.toggle("hidden", n !== name);
      });
      if (name === "dashboard") refreshDashboard().catch(()=>{});
      if (name === "ultimos") carregarUltimos().catch(()=>{});
    }

    let setTab = _setTabBase;
    tabEls.forEach(t => t.addEventListener("click", () => setTab(t.dataset.tab)));

    $("goLancar").addEventListener("click", () => setTab("lancar"));
    $("goUltimos").addEventListener("click", () => setTab("ultimos"));
    $("openLogin2").addEventListener("click", () => openAuthModal("entrar"));

    // -----------------------
    // Modal (auth + edit)
    // -----------------------
    const overlay = $("overlay");
    const segs = Array.from(document.querySelectorAll(".seg"));

    function openModal() {
      overlay.classList.add("show");
      overlay.setAttribute("aria-hidden", "false");
    }
    function closeModal() {
      overlay.classList.remove("show");
      overlay.setAttribute("aria-hidden", "true");
      ["toastAuth1","toastAuth2","toastAuth3","toastEdit"].forEach(id => hideToast($(id)));
    }

    $("closeModal").addEventListener("click", closeModal);
    $("btnFechar1").addEventListener("click", closeModal);
    $("btnFechar2").addEventListener("click", closeModal);
    $("btnFechar3").addEventListener("click", closeModal);
    overlay.addEventListener("click", (e) => { if (e.target === overlay) closeModal(); });

    function setSeg(seg) {
      segs.forEach(s => s.classList.toggle("active", s.dataset.seg === seg));
      $("seg-entrar").classList.toggle("hidden", seg !== "entrar");
      $("seg-criar").classList.toggle("hidden", seg !== "criar");
      $("seg-reset").classList.toggle("hidden", seg !== "reset");

      $("modalIcon").textContent = "ðŸ”’";
      $("modalTitle").textContent = seg === "entrar" ? "Login" : (seg === "criar" ? "Criar conta" : "Resetar senha");
      $("modalSub").textContent = seg === "entrar"
        ? "Entre com seu e-mail e senha."
        : (seg === "criar" ? "Crie sua conta para acessar seus lanÃ§amentos." : "Defina uma nova senha para sua conta.");

      $("authBlock").classList.remove("hidden");
      $("editBlock").classList.add("hidden");
      openModal();
    }

    segs.forEach(s => s.addEventListener("click", () => setSeg(s.dataset.seg)));
    function openAuthModal(seg="entrar") { setSeg(seg); }

    // -----------------------
    // Auth state (front only)
    // -----------------------
    let currentUserEmail = localStorage.getItem("financeai_user") || "";

    function setLoggedUI(isLogged, email="") {
      const pill = $("userPill");
      $("btnLogin").classList.toggle("hidden", isLogged);
      $("btnLogout").classList.toggle("hidden", !isLogged);
      pill.classList.toggle("hidden", !isLogged);
      pill.textContent = isLogged ? email : "";
    }

    if (currentUserEmail) setLoggedUI(true, currentUserEmail);
    else setLoggedUI(false);

    $("btnLogin").addEventListener("click", () => openAuthModal("entrar"));

    $("btnLogout").addEventListener("click", async () => {
      try { await api("/api/logout", "POST"); } catch(e) {}
      localStorage.removeItem("financeai_user");
      currentUserEmail = "";
      setLoggedUI(false);
      refreshDashboard().catch(()=>{});
      carregarUltimos().catch(()=>{});
    });

    // -----------------------
    // Auth actions
    // -----------------------
    $("btnEntrar").addEventListener("click", async () => {
      const t = $("toastAuth1"); hideToast(t);
      try {
        const email = $("loginEmail").value.trim().toLowerCase();
        const senha = $("loginSenha").value;
        const res = await api("/api/login", "POST", { email, senha });
        localStorage.setItem("financeai_user", res.email);
        currentUserEmail = res.email;
        setLoggedUI(true, res.email);
        showToast(t, "ok", "Login realizado", "VocÃª jÃ¡ pode lanÃ§ar e ver o dashboard.");
        setTimeout(() => { closeModal(); refreshDashboard().catch(()=>{}); }, 600);
      } catch (e) {
        showToast(t, "err", "Falha no login", e.message);
      }
    });

    $("btnCriarConta").addEventListener("click", async () => {
      const t = $("toastAuth2"); hideToast(t);
      try {
        const nome_apelido = $("regApelido").value.trim();
        const nome_completo = $("regNomeCompleto").value.trim();
        const telefone = $("regTelefone").value.trim();
        const email = $("regEmail").value.trim().toLowerCase();
        const senha = $("regSenha").value;
        const confirmar_senha = $("regConf").value;

        const res = await api("/api/register", "POST", {
          nome_apelido, nome_completo, telefone, email, senha, confirmar_senha
        });

        localStorage.setItem("financeai_user", res.email);
        currentUserEmail = res.email;
        setLoggedUI(true, res.email);

        showToast(t, "ok", "Conta criada", "Cadastro feito! VocÃª jÃ¡ estÃ¡ logado.");
        setTimeout(() => { closeModal(); refreshDashboard().catch(()=>{}); }, 600);
      } catch (e) {
        showToast(t, "err", "Erro ao cadastrar", e.message);
      }
    });

    $("btnResetar").addEventListener("click", async () => {
      const t = $("toastAuth3"); hideToast(t);
      try {
        const email = $("rstEmail").value.trim().toLowerCase();
        const nova_senha = $("rstSenha").value;
        const confirmar = $("rstConf").value;

        await api("/api/reset_password", "POST", { email, nova_senha, confirmar });
        showToast(t, "ok", "Senha alterada", "Agora vocÃª jÃ¡ pode entrar com a nova senha.");
      } catch (e) {
        showToast(t, "err", "Falha no reset", e.message);
      }
    });

    // -----------------------
    // Charts
    // -----------------------
    let chartRG = null;
    let chartSaldo = null;
    let chartDaily = null;

    function ensureCharts() {
      if (!window.Chart) return;

      const c1 = $("chartRG");
      const c2 = $("chartSaldo");
      const c3 = $("chartDaily");

      if (c1 && !chartRG) {
        chartRG = new Chart(c1, {
          type: "doughnut",
          data: {
            labels: ["Receitas", "Gastos"],
            datasets: [{
              data: [0, 0],
              backgroundColor: ["rgba(46,229,157,.85)", "rgba(255,75,110,.85)"],
              borderColor: ["rgba(46,229,157,.20)", "rgba(255,75,110,.20)"],
              borderWidth: 1,
              hoverOffset: 6
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { labels: { color: "rgba(234,240,255,.85)" } },
              tooltip: { callbacks: { label: (ctx) => `${ctx.label}: ${moneyBR(ctx.raw || 0)}` } }
            },
            cutout: "65%"
          }
        });
      }

      if (c2 && !chartSaldo) {
        chartSaldo = new Chart(c2, {
          type: "bar",
          data: {
            labels: ["Saldo"],
            datasets: [{
              label: "Saldo do mÃªs",
              data: [0],
              backgroundColor: ["rgba(75,140,255,.75)"],
              borderColor: ["rgba(75,140,255,.25)"],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: { callbacks: { label: (ctx) => moneyBR(ctx.raw || 0) } }
            },
            scales: {
              x: { ticks: { color: "rgba(234,240,255,.75)" }, grid: { color: "rgba(255,255,255,.06)" } },
              y: { ticks: { color: "rgba(234,240,255,.75)" }, grid: { color: "rgba(255,255,255,.06)" } }
            }
          }
        });
      }

      if (c3 && !chartDaily) {
        chartDaily = new Chart(c3, {
          type: "line",
          data: {
            labels: [],
            datasets: [
              {
                label: "Receitas (dia)",
                data: [],
                borderColor: "rgba(46,229,157,.9)",
                backgroundColor: "rgba(46,229,157,.12)",
                tension: 0.25,
                fill: true,
                pointRadius: 2
              },
              {
                label: "Gastos (dia)",
                data: [],
                borderColor: "rgba(255,75,110,.9)",
                backgroundColor: "rgba(255,75,110,.10)",
                tension: 0.25,
                fill: true,
                pointRadius: 2
              },
              {
                label: "Saldo acumulado",
                data: [],
                borderColor: "rgba(75,140,255,.95)",
                backgroundColor: "rgba(75,140,255,.12)",
                tension: 0.25,
                fill: false,
                pointRadius: 1
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { labels: { color: "rgba(234,240,255,.85)" } },
              tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: ${moneyBR(ctx.raw || 0)}` } }
            },
            scales: {
              x: { ticks: { color: "rgba(234,240,255,.75)" }, grid: { color: "rgba(255,255,255,.06)" } },
              y: { ticks: { color: "rgba(234,240,255,.75)" }, grid: { color: "rgba(255,255,255,.06)" } }
            }
          }
        });
      }
    }

    function updateChartsTotals(receitas, gastos, saldo) {
      ensureCharts();
      if (chartRG) {
        chartRG.data.datasets[0].data = [Number(receitas || 0), Number(gastos || 0)];
        chartRG.update();
      }
      if (chartSaldo) {
        const s = Number(saldo || 0);
        chartSaldo.data.datasets[0].data = [s];
        chartSaldo.data.datasets[0].backgroundColor = [s >= 0 ? "rgba(46,229,157,.75)" : "rgba(255,75,110,.75)"];
        chartSaldo.data.datasets[0].borderColor = [s >= 0 ? "rgba(46,229,157,.25)" : "rgba(255,75,110,.25)"];
        chartSaldo.update();
      }
    }

    function daysInMonth(year, month1to12) {
      return new Date(year, month1to12, 0).getDate();
    }

    function parseISODate(s) {
      const parts = String(s || "").split("-");
      if (parts.length !== 3) return null;
      const y = Number(parts[0]), m = Number(parts[1]), d = Number(parts[2]);
      if (!y || !m || !d) return null;
      return { y, m, d };
    }

    function parseMoneyLoose(v) {
      const n = Number(String(v ?? "").trim().replace(/\s/g,"").replace(/\./g,"").replace(",", "."));
      return isNaN(n) ? 0 : n;
    }

    async function updateDailyChart(mes, ano) {
      ensureCharts();
      if (!chartDaily) return;

      const dim = daysInMonth(ano, mes);
      const labels = Array.from({length: dim}, (_, i) => String(i + 1));
      const receitasDia = Array.from({length: dim}, () => 0);
      const gastosDia = Array.from({length: dim}, () => 0);

      try {
        const res = await api("/api/lancamentos?limit=200", "GET");
        const items = res.items || [];

        for (const it of items) {
          const dt = parseISODate(it.data);
          if (!dt) continue;
          if (dt.y !== ano || dt.m !== mes) continue;
          const idx = dt.d - 1;
          if (idx < 0 || idx >= dim) continue;

          const tipo = String(it.tipo || "").toUpperCase();
          const val = parseMoneyLoose(it.valor);

          if (tipo === "RECEITA") receitasDia[idx] += val;
          if (tipo === "GASTO") gastosDia[idx] += val;
        }
      } catch (e) {
        // nÃ£o logado => fica zerado
      }

      // saldo acumulado
      const saldoAcum = [];
      let acc = 0;
      for (let i = 0; i < dim; i++) {
        acc += (receitasDia[i] - gastosDia[i]);
        saldoAcum.push(acc);
      }

      chartDaily.data.labels = labels;
      chartDaily.data.datasets[0].data = receitasDia;
      chartDaily.data.datasets[1].data = gastosDia;
      chartDaily.data.datasets[2].data = saldoAcum;
      chartDaily.update();
    }

    // -----------------------
    // Dashboard
    // -----------------------
    function initMesAno() {
      const sel = $("dashMes");
      const now = new Date();
      const meses = ["Janeiro","Fevereiro","MarÃ§o","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
      sel.innerHTML = meses.map((m,i)=>`<option value="${i+1}">${m}</option>`).join("");
      sel.value = String(now.getMonth()+1);
      $("dashAno").value = String(now.getFullYear());
      $("lanData").value = now.toISOString().slice(0,10);
    }

    async function refreshDashboard() {
      const toast = $("toastDash"); hideToast(toast);
      const mes = Number($("dashMes").value);
      const ano = Number($("dashAno").value);

      try{
        const res = await api(`/api/dashboard?mes=${mes}&ano=${ano}`, "GET");
        $("valReceitas").textContent = moneyBR(res.receitas);
        $("valGastos").textContent = moneyBR(res.gastos);
        $("valSaldo").textContent = moneyBR(res.saldo);

        updateChartsTotals(res.receitas, res.gastos, res.saldo);
        await updateDailyChart(mes, ano);
      }catch(e){
        $("valReceitas").textContent = "R$ 0,00";
        $("valGastos").textContent = "R$ 0,00";
        $("valSaldo").textContent = "R$ 0,00";
        updateChartsTotals(0, 0, 0);
        await updateDailyChart(mes, ano);
        showToast(toast, "err", "FaÃ§a login para ver o dashboard", e.message);
      }
    }

    $("btnAtualizarDash").addEventListener("click", () => refreshDashboard());
    $("dashMes").addEventListener("change", () => refreshDashboard().catch(()=>{}));
    $("dashAno").addEventListener("change", () => refreshDashboard().catch(()=>{}));

    // -----------------------
    // Criar lanÃ§amento
    // -----------------------
    $("btnSalvarLanc").addEventListener("click", async () => {
      const toast = $("toastLanc"); hideToast(toast);
      try{
        const payload = {
          tipo: $("lanTipo").value,
          data: $("lanData").value,
          categoria: $("lanCategoria").value.trim(),
          descricao: $("lanDescricao").value.trim(),
          valor: $("lanValor").value.trim(),
        };
        await api("/api/lancamentos", "POST", payload);
        showToast(toast, "ok", "Salvo!", "LanÃ§amento registrado com sucesso.");
        $("lanCategoria").value = "";
        $("lanDescricao").value = "";
        $("lanValor").value = "";
        refreshDashboard().catch(()=>{});
        carregarUltimos().catch(()=>{});
      }catch(e){
        showToast(toast, "err", "Erro ao salvar", e.message);
      }
    });

    $("btnLimparLanc").addEventListener("click", () => {
      $("lanCategoria").value = "";
      $("lanDescricao").value = "";
      $("lanValor").value = "";
      hideToast($("toastLanc"));
    });

    // -----------------------
    // Ãšltimos + Editar + Apagar
    // -----------------------
    $("btnRecarregarUltimos").addEventListener("click", () => carregarUltimos());

    function normalizeValorToMoneyBR(raw) {
      const n = Number(String(raw ?? "").trim().replace(/\s/g,"").replace(/\./g,"").replace(",", "."));
      if (!isNaN(n)) return n.toLocaleString("pt-BR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      return String(raw ?? "");
    }

    async function carregarUltimos() {
      const toast = $("toastUltimos");
      const list = $("listaUltimos");
      hideToast(toast);
      list.innerHTML = "";

      try {
        const res = await api("/api/lancamentos?limit=30", "GET");
        const items = res.items || [];

        if (items.length === 0) {
          list.innerHTML = `<div class="muted">Nenhum lanÃ§amento ainda.</div>`;
          return;
        }

        list.innerHTML = items.map(it => {
          const valorNum = Number(String(it.valor).replace(/\./g,"").replace(",", "."));
          const v = isNaN(valorNum) ? it.valor : moneyBR(valorNum);

          const desc = (it.descricao || "").replace(/</g,"&lt;").replace(/>/g,"&gt;");
          const cat = (it.categoria || "Sem categoria").replace(/</g,"&lt;").replace(/>/g,"&gt;");

          return `
            <div class="miniCard">
              <div class="row" style="gap:12px;align-items:flex-start">
                <div style="min-width:92px" class="muted"><b>${it.data}</b></div>
                <div style="flex:1">
                  <div style="font-weight:900">${it.tipo} â€¢ ${cat}</div>
                  <div class="muted" style="margin-top:4px;font-size:13px">${desc}</div>
                </div>
                <div style="text-align:right;min-width:130px">
                  <div style="font-weight:900">${v}</div>
                  <div class="row" style="justify-content:flex-end;margin-top:8px">
                    <button class="btn small" onclick='abrirEdicao(${JSON.stringify(it).replace(/'/g,"&#39;")})'>Editar</button>
                    <button class="btn danger small" onclick="apagarLancamento(${it.row})">Apagar</button>
                  </div>
                </div>
              </div>
            </div>
          `;
        }).join("");

      } catch (e) {
        showToast(toast, "err", "Erro ao carregar", e.message);
      }
    }

    async function apagarLancamento(row) {
      const toast = $("toastUltimos");
      hideToast(toast);
      if (!confirm("Quer mesmo apagar este lanÃ§amento?")) return;

      try {
        await api(`/api/lancamentos/${row}`, "DELETE");
        showToast(toast, "ok", "Apagado!", "LanÃ§amento removido.");
        await carregarUltimos();
        await refreshDashboard();
      } catch (e) {
        showToast(toast, "err", "NÃ£o foi possÃ­vel apagar", e.message);
      }
    }

    // ---- Edit Modal ----
    let editingRow = null;

    function openEditModal() {
      $("authBlock").classList.add("hidden");
      $("editBlock").classList.remove("hidden");
      $("modalIcon").textContent = "âœï¸";
      $("modalTitle").textContent = "Editar lanÃ§amento";
      $("modalSub").textContent = "Edite e salve. A alteraÃ§Ã£o atualiza sua planilha.";
      openModal();
    }

    window.abrirEdicao = (it) => {
      if (!currentUserEmail) return openAuthModal("entrar");

      editingRow = it.row;
      $("edtTipo").value = (it.tipo || "GASTO").toUpperCase();
      $("edtData").value = it.data || new Date().toISOString().slice(0,10);
      $("edtCategoria").value = it.categoria || "";
      $("edtDescricao").value = it.descricao || "";
      $("edtValor").value = normalizeValorToMoneyBR(it.valor);

      hideToast($("toastEdit"));
      openEditModal();
    };

    window.apagarLancamento = apagarLancamento;

    $("btnCancelarEdicao").addEventListener("click", () => {
      editingRow = null;
      closeModal();
    });

    $("btnSalvarEdicao").addEventListener("click", async () => {
      const toast = $("toastEdit");
      hideToast(toast);

      if (!editingRow) {
        showToast(toast, "err", "Nada para editar", "Selecione um lanÃ§amento para editar.");
        return;
      }

      try {
        const payload = {
          tipo: $("edtTipo").value,
          data: $("edtData").value,
          categoria: $("edtCategoria").value.trim(),
          descricao: $("edtDescricao").value.trim(),
          valor: $("edtValor").value.trim(),
        };

        await api(`/api/lancamentos/${editingRow}`, "PUT", payload);
        showToast(toast, "ok", "Atualizado!", "LanÃ§amento editado com sucesso.");
        await carregarUltimos();
        await refreshDashboard();
        setTimeout(() => { closeModal(); }, 450);
      } catch (e) {
        showToast(toast, "err", "Erro ao editar", e.message);
      }
    });

    // -----------------------
    // Boot
    // -----------------------
    initMesAno();
    ensureCharts();
    refreshDashboard().catch(()=>{});
  </script>

  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("/static/sw.js?v=3").catch(() => {});
      });
    }
  </script>
</body>
</html>
